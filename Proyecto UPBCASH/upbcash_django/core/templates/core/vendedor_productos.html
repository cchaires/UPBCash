{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UPBCash - Productos</title>
  <link rel="stylesheet" href="{% static 'core/css/styles_vendedor_layout.css' %}" />
</head>
<body>
  <div class="page">
    <div class="app-shell">
      <aside class="sidebar">
        <div class="brand">
          <img class="brand__logo" src="{% static 'core/img/imgupbcash-logo-c.png' %}" alt="UPBCash" />
        </div>

        <nav class="nav" aria-label="Secciones del vendedor">
          <a class="nav__item" href="{% url 'vendedor' %}">
            <span class="nav__icon">üè†</span><span>Inicio</span>
          </a>
          <a class="nav__item" href="{% url 'vendedor_tienda' %}">
            <span class="nav__icon">üè™</span><span>Tienda</span>
          </a>
          <a class="nav__item nav__item--active" href="{% url 'vendedor_productos' %}">
            <span class="nav__icon">üçΩÔ∏è</span><span>Productos</span>
          </a>
          <a class="nav__item" href="{% url 'vendedor_ventas' %}">
            <span class="nav__icon">üìä</span><span>Ventas</span>
          </a>
          <a class="nav__item" href="{% url 'vendedor_mapa' %}">
            <span class="nav__icon">üó∫Ô∏è</span><span>Mapa</span>
          </a>
        </nav>

        <div class="sidebar__spacer"></div>

        <div class="userbox">
          <div class="userbox__avatar">üë§</div>
          <div class="userbox__info">
            <div class="userbox__name">{{ user_display_name }}</div>
            <div class="userbox__sub">Vendedor</div>
          </div>
          <button class="userbox__toggle" id="userToggle" aria-haspopup="true" aria-expanded="false" aria-label="Abrir menu de cuenta">‚ñæ</button>
          <div class="userbox__menu" id="userMenu" role="menu" aria-hidden="true">
            <a href="{% url 'cliente' %}" role="menuitem">Cliente</a>
            {% if can_view_vendor %}
            <a href="{% url 'vendedor' %}" role="menuitem">Vendedor</a>
            {% endif %}
            {% if can_view_staff %}
            <a href="{% url 'staff_panel' %}" role="menuitem">Staff</a>
            {% endif %}
            <a href="{% url 'logout' %}" role="menuitem">Cerrar sesion</a>
          </div>
        </div>
      </aside>

      <main class="main">
        <div class="main__inner main__inner--scroll">
          <header class="main__header">
            <div class="title-block">
              <h1>Gestion de productos</h1>
              {% if assignment %}
              <p>Catalogo activo para {{ assignment.stall.name }}.</p>
              {% else %}
              <p>Aun no tienes una tienda creada en el evento activo.</p>
              {% endif %}
            </div>
            <div class="status-pill">
              {% if event %}{{ event.name }}{% else %}Sin evento activo{% endif %}
            </div>
          </header>

          <section class="panel">
            <div class="panel__title">
              <h2>Imagen de tienda</h2>
            </div>
            {% if assignment %}
            <form method="post" action="{% url 'vendedor_productos' %}" enctype="multipart/form-data" class="form form--wide">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_stall_image" />
              <div class="field">
                <label for="stall_image">Imagen principal de la tienda</label>
                <input class="input" id="stall_image" name="stall_image" type="file" accept="image/*" />
                {% if stall_image_url %}
                <div style="margin-top: 8px;">
                  <img src="{{ stall_image_url }}" alt="Imagen de la tienda" style="max-width: 220px; border-radius: 10px;" />
                </div>
                <label class="inline-check"><input type="checkbox" name="remove_stall_image" /> Quitar imagen actual</label>
                {% endif %}
              </div>
              <div class="actions-row">
                <button class="btn btn--secondary" type="submit">Guardar imagen de tienda</button>
              </div>
            </form>
            {% else %}
            <p class="item__desc">Necesitas crear tu tienda para gestionar su imagen.</p>
            {% endif %}
          </section>

          <section class="panel" style="margin-top: 16px;">
            <div class="panel__title">
              <h2>{% if form_product %}Editar producto{% else %}Agregar nuevo producto{% endif %}</h2>
            </div>

            {% if messages %}
              {% for message in messages %}
                <p class="helper" style="margin: 0 0 12px; color:{% if message.tags == 'error' %}#b00020{% elif message.tags == 'warning' %}#7a5200{% else %}#2f8f5b{% endif %};">{{ message }}</p>
              {% endfor %}
            {% endif %}

            {% if assignment %}
            <form method="post" action="{% url 'vendedor_productos' %}" enctype="multipart/form-data" class="form form--wide product-form-grid">
              {% csrf_token %}
              <input type="hidden" name="action" value="save_product" />
              {% if form_product %}<input type="hidden" name="product_id" value="{{ form_product.id }}" />{% endif %}

              <div class="field">
                <label for="display_name">Nombre visible</label>
                <input class="input" id="display_name" name="display_name" type="text" maxlength="120" value="{{ form_product.display_name|default:'' }}" required />
              </div>

              <div class="field">
                <label for="description">Descripcion</label>
                <input class="input" id="description" name="description" type="text" maxlength="240" value="{% if form_product %}{{ form_product.catalog_product.description }}{% endif %}" />
              </div>

              <div class="field">
                <label for="item_nature">Tipo contable</label>
                <select class="input" id="item_nature" name="item_nature" required>
                  {% for value, label in item_nature_options %}
                  <option value="{{ value }}" {% if value == selected_item_nature %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="field">
                <label for="category_id">Categoria</label>
                <select class="input" id="category_id" name="category_id" required>
                  <option value="">Selecciona categoria</option>
                  {% for category in category_options %}
                  <option value="{{ category.id }}" {% if selected_category_id == category.id|stringformat:'s' %}selected{% endif %}>{{ category.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="field">
                <label for="subcategory_id">Subcategoria</label>
                <select class="input" id="subcategory_id" name="subcategory_id" required>
                  <option value="">Selecciona subcategoria</option>
                  {% for subcategory in subcategory_options %}
                  <option value="{{ subcategory.id }}" {% if selected_subcategory_id == subcategory.id|stringformat:'s' %}selected{% endif %}>{{ subcategory.category.name }} ¬∑ {{ subcategory.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="field">
                <label for="price_ucoin">Precio de venta (UCoin)</label>
                <input class="input" id="price_ucoin" name="price_ucoin" type="number" min="0" step="0.01" value="{{ form_product.price_ucoin|default:'' }}" required />
              </div>

              <div class="field">
                <label for="cost_ucoin">Costo unitario (UCoin)</label>
                <input class="input" id="cost_ucoin" name="cost_ucoin" type="number" min="0" step="0.01" value="{{ form_product.cost_ucoin|default:'0.00' }}" required />
              </div>

              <div class="field">
                <label for="stock_qty">Stock inventariable</label>
                <input class="input" id="stock_qty" name="stock_qty" type="number" min="0" step="1" value="{{ form_product.stock_qty|default:'' }}" />
              </div>

              <div class="field">
                <label for="image">Imagen del producto</label>
                <input class="input" id="image" name="image" type="file" accept="image/*" />
                {% if form_product and form_product.image %}
                <label class="inline-check"><input type="checkbox" name="remove_image" /> Quitar imagen actual</label>
                {% endif %}
              </div>

              <div class="field field--inline">
                <label class="inline-check"><input type="checkbox" name="is_active" {% if form_product %}{% if form_product.is_active %}checked{% endif %}{% else %}checked{% endif %} /> Producto activo</label>
              </div>

              <div class="actions-row">
                <button class="btn btn--primary" type="submit">{% if form_product %}Guardar cambios{% else %}Agregar producto{% endif %}</button>
                {% if form_product %}
                <a class="btn btn--secondary" href="{% url 'vendedor_productos' %}">Cancelar edicion</a>
                {% endif %}
              </div>
            </form>
            {% else %}
            <p class="item__desc">Primero crea tu tienda para habilitar el catalogo de productos.</p>
            <a class="btn btn--secondary" href="{% url 'vendedor_tienda' %}">Crear tienda</a>
            {% endif %}
          </section>

          <section class="panel" style="margin-top: 16px;">
            <div class="panel__title">
              <h2>Productos publicados</h2>
            </div>
            <div class="menu-grid">
              {% for product in stall_products %}
              <article class="menu-item">
                <div class="item__photo item__photo--{{ product.photo_variant }}">
                  <img src="{{ product.image_url }}" alt="{{ product.name }}" class="item__photo-img" />
                </div>
                <div class="item__name">{{ product.name }}</div>
                <div class="item__desc">{{ product.category_name }}{% if product.subcategory_name %} ¬∑ {{ product.subcategory_name }}{% endif %} ¬∑ {{ product.item_nature }}</div>
                <div class="item__desc">Precio: ${{ product.price|floatformat:2 }} ¬∑ Costo: ${{ product.cost|floatformat:2 }} ¬∑ Stock: {{ product.stock_text }}</div>
                <div class="item__price"><span>{{ product.availability_label }}</span><span class="item__badge">{{ product.badge_label }}</span></div>
                <a class="btn btn--secondary btn--sm" href="{% url 'vendedor_productos' %}?edit={{ product.id }}">Editar</a>
                {% if product.is_active %}
                <form method="post" action="{% url 'vendedor_productos' %}" style="margin-top: 8px;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="delete_product" />
                  <input type="hidden" name="product_id" value="{{ product.id }}" />
                  <button class="btn btn--secondary btn--sm" type="submit">Desactivar</button>
                </form>
                {% endif %}
              </article>
              {% empty %}
              <article class="menu-item">
                <div class="item__photo item__photo--combo">Sin menu</div>
                <div class="item__name">No hay productos publicados</div>
                <div class="item__desc">Usa el formulario superior para cargar tu primer producto.</div>
                <div class="item__price"><span>Sin datos</span><span class="item__badge">--</span></div>
              </article>
              {% endfor %}
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <script src="{% static 'core/js/dropdown_cliente.js' %}"></script>
</body>
</html>
