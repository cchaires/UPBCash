{% extends 'core/layouts/staff_shell.html' %}

{% block title %}UPBCash - Mapa asignacion{% endblock %}

{% block content %}
<header class="main__header">
  <div>
    <h1 class="page-title">Mapa visual de asignacion</h1>
    <p class="page-subtitle">Evento {{ event.code }} Â· maximo de espacios: {{ event.max_map_spots }}.</p>
  </div>
  <div class="status-pill">Spots actuales: <span id="spotCount">{{ spot_count }}</span></div>
</header>

{% include 'core/includes/flash_messages.html' %}

<section class="card mt-14">
  <div class="layout-grid">
    <div>
      <div class="actions-row mb-8">
        <button id="btnCreateMode" class="btn btn--secondary" type="button">Modo crear spot</button>
        <button id="btnMoveMode" class="btn btn--secondary" type="button">Mover spot seleccionado</button>
        <button id="btnDeleteSpot" class="btn btn--danger" type="button">Eliminar spot</button>
      </div>
      <p class="hint">Haz click en el mapa para crear o mover spots (coordenadas normalizadas 0..1).</p>
      <div class="map-wrap" id="mapWrap">
        <img id="mapImage" src="{{ map_image_url }}" alt="Mapa evento" />
      </div>
    </div>

    <div>
      <div class="field">
        <label for="stallSelect">Tienda</label>
        <select class="input" id="stallSelect"><option value="">Selecciona tienda</option></select>
      </div>
      <div class="field">
        <label for="vendorSelect">Agregar vendedor a tienda</label>
        <select class="input" id="vendorSelect"><option value="">Selecciona vendedor</option></select>
      </div>
      <div class="actions-row mb-12">
        <button id="btnAssignSpot" class="btn btn--secondary" type="button">Asignar spot seleccionado</button>
        <button id="btnAddVendor" class="btn btn--secondary" type="button">Agregar vendedor</button>
      </div>
      <div id="apiMessage" class="hint"></div>

      <h3 class="page-title mt-12">Tiendas del evento</h3>
      <div class="staff-mini-list" id="stallList"></div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  const eventId = {{ event.id }};
  const mapWrap = document.getElementById('mapWrap');
  const mapImage = document.getElementById('mapImage');
  const stallSelect = document.getElementById('stallSelect');
  const vendorSelect = document.getElementById('vendorSelect');
  const stallList = document.getElementById('stallList');
  const apiMessage = document.getElementById('apiMessage');
  const spotCount = document.getElementById('spotCount');

  let state = { spots: [], stalls: [], vendors: [], event: null };
  let selectedSpotId = null;
  let mode = 'idle';

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }

  async function apiCall(url, method = 'GET', payload = null) {
    const init = {
      method,
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Accept': 'application/json'
      }
    };
    if (payload !== null) {
      init.headers['Content-Type'] = 'application/json';
      init.body = JSON.stringify(payload);
    }
    const resp = await fetch(url, init);
    const data = await resp.json();
    if (!resp.ok || data.ok === false) {
      throw new Error(data.error || 'Error en la operacion');
    }
    return data;
  }

  function setMessage(text, isError = false) {
    apiMessage.textContent = text;
    apiMessage.className = `hint ${isError ? 'text-error' : 'text-success'}`;
  }

  function clearMapSpots() {
    mapWrap.querySelectorAll('.map-spot').forEach((el) => el.remove());
  }

  function renderMapSpots() {
    clearMapSpots();
    state.spots.forEach((spot) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = `map-spot ${spot.stall_id ? 'map-spot--assigned' : ''} ${spot.status === 'blocked' ? 'map-spot--blocked' : ''}`;
      if (spot.id === selectedSpotId) btn.classList.add('selected');
      btn.style.left = `${spot.x * 100}%`;
      btn.style.top = `${spot.y * 100}%`;
      btn.textContent = spot.label;
      btn.title = spot.stall_name ? `${spot.label} - ${spot.stall_name}` : spot.label;
      btn.addEventListener('click', (ev) => {
        ev.stopPropagation();
        selectedSpotId = spot.id;
        renderMapSpots();
      });
      mapWrap.appendChild(btn);
    });
    spotCount.textContent = String(state.spots.length);
  }

  function renderStallOptions() {
    stallSelect.innerHTML = '<option value="">Selecciona tienda</option>';
    state.stalls.forEach((stall) => {
      const option = document.createElement('option');
      option.value = String(stall.id);
      option.textContent = `${stall.name}${stall.assigned_spot_label ? ` (spot ${stall.assigned_spot_label})` : ''}`;
      stallSelect.appendChild(option);
    });
  }

  function renderVendorOptions() {
    vendorSelect.innerHTML = '<option value="">Selecciona vendedor</option>';
    state.vendors.forEach((vendor) => {
      const option = document.createElement('option');
      option.value = String(vendor.user_id);
      option.textContent = `${vendor.username}${vendor.matricula ? ` (${vendor.matricula})` : ''}`;
      vendorSelect.appendChild(option);
    });
  }

  function renderStallList() {
    stallList.innerHTML = '';
    state.stalls.forEach((stall) => {
      const item = document.createElement('div');
      item.className = 'staff-mini-item';
      const members = stall.members.map((m) => `${m.username} (${m.role})`).join(', ') || 'Sin vendedores';
      item.innerHTML = `<div><strong>${stall.name}</strong></div><div class="hint">${stall.code}</div><div class="hint">Spot: ${stall.assigned_spot_label || 'Sin asignar'}</div><div class="hint">Vendedores: ${members}</div>`;
      stallList.appendChild(item);
    });
  }

  async function loadState() {
    try {
      const data = await apiCall(`/api/events/${eventId}/map/state`);
      state = data;
      renderMapSpots();
      renderStallOptions();
      renderVendorOptions();
      renderStallList();
    } catch (err) {
      setMessage(err.message, true);
    }
  }

  function getClickCoordinates(ev) {
    const rect = mapImage.getBoundingClientRect();
    const x = (ev.clientX - rect.left) / rect.width;
    const y = (ev.clientY - rect.top) / rect.height;
    return { x: Math.max(0, Math.min(1, x)), y: Math.max(0, Math.min(1, y)) };
  }

  mapWrap.addEventListener('click', async (ev) => {
    const coords = getClickCoordinates(ev);
    try {
      if (mode === 'create') {
        await apiCall(`/api/events/${eventId}/map/spots`, 'POST', coords);
        setMessage('Spot creado.');
      } else if (mode === 'move' && selectedSpotId) {
        await apiCall(`/api/events/${eventId}/map/spots/${selectedSpotId}`, 'PATCH', coords);
        setMessage('Spot movido.');
      }
      await loadState();
    } catch (err) {
      setMessage(err.message, true);
    }
  });

  document.getElementById('btnCreateMode').addEventListener('click', () => {
    mode = mode === 'create' ? 'idle' : 'create';
    setMessage(mode === 'create' ? 'Modo crear activo.' : 'Modo crear desactivado.');
  });

  document.getElementById('btnMoveMode').addEventListener('click', () => {
    mode = mode === 'move' ? 'idle' : 'move';
    setMessage(mode === 'move' ? 'Modo mover activo. Selecciona un spot y luego click en mapa.' : 'Modo mover desactivado.');
  });

  document.getElementById('btnDeleteSpot').addEventListener('click', async () => {
    if (!selectedSpotId) {
      setMessage('Selecciona un spot para eliminar.', true);
      return;
    }
    try {
      await apiCall(`/api/events/${eventId}/map/spots/${selectedSpotId}`, 'DELETE');
      selectedSpotId = null;
      setMessage('Spot eliminado.');
      await loadState();
    } catch (err) {
      setMessage(err.message, true);
    }
  });

  document.getElementById('btnAssignSpot').addEventListener('click', async () => {
    const stallId = stallSelect.value;
    if (!stallId || !selectedSpotId) {
      setMessage('Selecciona tienda y spot.', true);
      return;
    }
    try {
      await apiCall(`/api/events/${eventId}/stalls/${stallId}/assign-spot`, 'POST', { spot_id: selectedSpotId });
      setMessage('Spot asignado a tienda.');
      await loadState();
    } catch (err) {
      setMessage(err.message, true);
    }
  });

  document.getElementById('btnAddVendor').addEventListener('click', async () => {
    const stallId = stallSelect.value;
    const vendorId = vendorSelect.value;
    if (!stallId || !vendorId) {
      setMessage('Selecciona tienda y vendedor.', true);
      return;
    }
    try {
      await apiCall(`/api/events/${eventId}/stalls/${stallId}/add-vendor`, 'POST', { vendor_user_id: vendorId });
      setMessage('Vendedor agregado.');
      await loadState();
    } catch (err) {
      setMessage(err.message, true);
    }
  });

  loadState();
</script>
{% endblock %}
