{% extends 'core/layouts/staff_shell.html' %}

{% block title %}UPBCash - Panel staff{% endblock %}

{% block content %}
<header class="main__header">
  <div>
    <h1 class="page-title">Panel staff</h1>
    <p class="page-subtitle">Permisos por perfil y auditoria del evento activo.</p>
  </div>
  <div class="status-pill">Evento: {% if event %}{{ event.code }}{% else %}Sin evento activo{% endif %}</div>
</header>

{% if not event %}
<section class="card mt-14">
  <p class="helper mt-0 mb-0">No hay evento activo. Puedes consultar el panel, pero las acciones operativas estan bloqueadas hasta abrir un nuevo evento.</p>
</section>
{% endif %}

<section class="card staff-grid-summary">
  <article class="menu-item"><div class="item__name">Usuarios en evento</div><div class="item__price"><span>{{ total_users }}</span></div></article>
  <article class="menu-item"><div class="item__name">Usuarios staff</div><div class="item__price"><span>{{ total_staff }}</span></div></article>
  <article class="menu-item"><div class="item__name">Usuarios vendedor</div><div class="item__price"><span>{{ total_vendors }}</span></div></article>
  <article class="menu-item"><div class="item__name">Asignaciones activas</div><div class="item__price"><span>{{ total_assignments }}</span></div></article>
</section>

{% include 'core/includes/flash_messages.html' %}

<section class="card mt-14">
  <form class="form filter-row staff-search" method="get" action="{% url 'staff_panel' %}">
    <div class="field">
      <label for="search">Buscar usuario</label>
      <input class="input" id="search" name="q" value="{{ search_query }}" placeholder="username, email o matricula" />
    </div>
    <div class="actions-row">
      <button class="btn btn--secondary" type="submit">Buscar</button>
      <a class="btn btn--ghost" href="{% url 'staff_panel' %}">Limpiar</a>
    </div>
  </form>
</section>

<section class="card mt-14">
  <h2 class="page-title staff-section-title">Permisos por usuario</h2>
  <div class="table-wrap">
    <table class="staff-table">
      <thead>
        <tr><th>Usuario</th><th>Roles</th><th>Asignacion</th><th>Acciones</th></tr>
      </thead>
      <tbody>
        {% for row in user_rows %}
        <tr>
          <td>
            <div class="item__name">{{ row.membership.user.username }}</div>
            <div class="item__desc">{{ row.membership.user.email|default:"Sin email" }}</div>
            <div class="item__desc">Matricula: {{ row.membership.matricula|default:"-" }}</div>
          </td>
          <td>
            {% for role_name in row.group_names %}
            <span class="staff-role {% if role_name == 'staff' %}staff-role--staff{% elif role_name == 'vendedor' %}staff-role--vendor{% else %}staff-role--default{% endif %}">{{ role_name }}</span>
            {% empty %}
            <span class="item__desc">Sin rol especial</span>
            {% endfor %}
          </td>
          <td>
            {% if row.vendor_membership %}
            <div class="item__desc">{{ row.vendor_membership.stall.name }}</div>
            {% if row.location_assignment %}
            <div class="item__desc">Espacio {{ row.location_assignment.spot.label }}</div>
            {% else %}
            <div class="item__desc">Sin espacio en mapa</div>
            {% endif %}
            {% else %}
            <div class="item__desc">Sin tienda asignada</div>
            {% endif %}
          </td>
          <td>
            <form method="post" action="{% url 'staff_panel' %}" class="staff-role-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="sync_roles" />
              <input type="hidden" name="target_user_id" value="{{ row.membership.user_id }}" />
              <input type="hidden" name="next_query" value="{{ current_query_string }}" />
              <div class="staff-role-grid">
                {% for role_name in manageable_groups %}
                <label class="staff-role-check{% if role_name == 'cliente' and role_name in row.group_names %} staff-role-check--locked{% elif role_name == 'staff' and role_name in row.group_names and row.membership.user_id == current_staff_user_id %} staff-role-check--locked{% endif %}">
                  <input type="checkbox" name="group_names" value="{{ role_name }}" {% if role_name in row.group_names %}checked{% endif %} {% if role_name == 'cliente' and role_name in row.group_names %}disabled{% elif role_name == 'staff' and role_name in row.group_names and row.membership.user_id == current_staff_user_id %}disabled{% endif %} />
                  <span>{{ role_name }}</span>
                </label>
                {% if role_name in row.group_names %}
                  {% if role_name == 'cliente' %}
                  <input type="hidden" name="group_names" value="{{ role_name }}" />
                  {% elif role_name == 'staff' and row.membership.user_id == current_staff_user_id %}
                  <input type="hidden" name="group_names" value="{{ role_name }}" />
                  {% endif %}
                {% endif %}
                {% endfor %}
              </div>
              <button class="btn btn--secondary btn--mini" type="submit">Guardar roles</button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="4">No se encontraron usuarios para este criterio.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<section class="card mt-14">
  <h2 class="page-title staff-section-title">Operaciones visuales</h2>
  <div class="list">
    <article class="list-item">
      <div>
        <div class="list-item__title">Campanas y evento publico</div>
        <div class="list-item__meta">Configura fechas de campana, ventana publica y maximo de espacios.</div>
      </div>
      <a class="btn btn--secondary" href="{% url 'staff_eventos' %}">Abrir eventos</a>
    </article>
    <article class="list-item">
      <div>
        <div class="list-item__title">Mapa de asignacion</div>
        <div class="list-item__meta">Gestiona spots por click y asigna tiendas/vendedores visualmente.</div>
      </div>
      {% if can_manage_assignments and event %}
      <a class="btn btn--secondary" href="{% url 'staff_mapa_asignacion' %}">Abrir mapa</a>
      {% else %}
      <span class="item__desc">No disponible</span>
      {% endif %}
    </article>
  </div>
</section>

<section class="card mt-14">
  <h2 class="page-title staff-section-title">Bitacora reciente</h2>
  <div class="table-wrap">
    <table class="staff-table">
      <thead><tr><th>Fecha</th><th>Staff</th><th>Accion</th><th>Detalle</th></tr></thead>
      <tbody>
        {% for log in audit_logs %}
        <tr>
          <td>{{ log.created_at|date:"d/m/Y H:i" }}</td>
          <td>{{ log.staff_user.username }}</td>
          <td>{{ log.action_type }}</td>
          <td>{{ log.payload_json }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="4">Sin acciones registradas.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
