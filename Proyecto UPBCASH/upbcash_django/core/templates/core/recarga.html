{% extends 'core/layouts/client_shell.html' %}
{% load static %}

{% block title %}UPBCash - Recarga de saldo{% endblock %}

{% block content %}
<section class="card">
  <header class="card__header">
    <div>
      <h1 class="card__title">Recargar saldo</h1>
      <p class="card__subtitle">Simulacion de compra con PayPal.</p>
    </div>
    <div class="saldo-pill">Saldo actual: <span id="saldoValue">${{ saldo_actual|floatformat:2 }}</span></div>
    <a class="btn btn--ghost" href="{% url 'cliente' %}">Volver</a>
  </header>

  {% if error_message %}
  <p class="flash flash--error">{{ error_message }}</p>
  {% endif %}
  {% include 'core/includes/flash_messages.html' %}

  <div class="checkout-grid">
    <div>
      <div class="status-pill mb-12">PayPal Â· Pago seguro simulado</div>

      <form class="field-grid" id="payForm" method="post" action="{% url 'recarga' %}">
        {% csrf_token %}
        <div class="field">
          <label for="amount">Monto a recargar</label>
          <input id="amount" name="amount" type="text" inputmode="numeric" autocomplete="off" placeholder="Ej. 100" required />
        </div>

        <div class="field">
          <label for="name">Nombre del titular</label>
          <input id="name" name="holder_name" type="text" placeholder="Nombre completo" required />
        </div>

        <div class="field">
          <label for="card">Numero de tarjeta</label>
          <input id="card" name="card" type="text" inputmode="numeric" autocomplete="off" maxlength="19" placeholder="1234 5678 9012 3456" required />
        </div>

        <div class="inline">
          <div class="field">
            <label for="exp">Fecha de expiracion</label>
            <input id="exp" name="exp" type="text" inputmode="numeric" autocomplete="off" maxlength="5" placeholder="MM/AA" required />
          </div>
          <div class="field">
            <label for="cvv">CVV</label>
            <input id="cvv" name="cvv" type="password" inputmode="numeric" autocomplete="off" maxlength="3" placeholder="123" required />
          </div>
        </div>

        <div class="actions">
          <button class="btn btn--primary" type="submit">Comprar saldo</button>
        </div>

        <div class="helper">Esta compra es una simulacion para el prototipo.</div>
      </form>
    </div>

    <aside class="summary">
      <div class="summary__title">Resumen de pago</div>
      <div class="summary__row">
        <span>Monto a recargar</span>
        <span id="amountValue">$0.00</span>
      </div>
      <div class="summary__row">
        <span>Comision</span>
        <span>$0.00</span>
      </div>
      <div class="summary__row summary__total">
        <span>Total a pagar</span>
        <span id="totalValue">$0.00</span>
      </div>
      <div class="result" id="result">Pago simulado.</div>
    </aside>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{% static 'core/js/saldo_cliente.js' %}"></script>
<script>
  setUpbcashSaldo({{ saldo_actual|floatformat:2 }});

  const amountInput = document.getElementById("amount");
  const amountValue = document.getElementById("amountValue");
  const totalValue = document.getElementById("totalValue");
  const cardInput = document.getElementById("card");
  const expInput = document.getElementById("exp");
  const cvvInput = document.getElementById("cvv");
  const form = document.getElementById("payForm");
  const saldoEl = document.getElementById("saldoValue");

  const updateSaldo = () => {
    const current = getUpbcashSaldo();
    if (saldoEl) saldoEl.textContent = formatUpbcashCurrency(current);
  };

  const digitsOnly = (value) => value.replace(/\D/g, "");

  const formatCurrency = (value) => {
    const number = Number(digitsOnly(String(value)));
    if (!number || number <= 0) return "$0.00";
    return formatUpbcashCurrency(number);
  };

  const updateSummary = () => {
    const value = digitsOnly(amountInput.value);
    amountInput.value = value;
    const formatted = formatCurrency(value);
    amountValue.textContent = formatted;
    totalValue.textContent = formatted;
  };

  amountInput?.addEventListener("input", updateSummary);

  cardInput?.addEventListener("input", () => {
    const digits = digitsOnly(cardInput.value).slice(0, 16);
    const groups = digits.match(/.{1,4}/g) || [];
    cardInput.value = groups.join(" ");
  });

  expInput?.addEventListener("input", () => {
    const digits = digitsOnly(expInput.value).slice(0, 4);
    const month = digits.slice(0, 2);
    const year = digits.slice(2, 4);
    expInput.value = year ? `${month}/${year}` : month;
  });

  cvvInput?.addEventListener("input", () => {
    cvvInput.value = digitsOnly(cvvInput.value).slice(0, 3);
  });

  form?.addEventListener("submit", (event) => {
    updateSummary();
    const value = Number(digitsOnly(amountInput.value || 0));
    amountInput.value = String(value);
    if (value <= 0) {
      event.preventDefault();
    }
  });

  updateSummary();
  updateSaldo();
</script>
{% endblock %}
